<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Messages</title>
<script src="https://cdn.tailwindcss.com"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, query, where, orderBy, doc, onSnapshot,
  updateDoc, arrayUnion
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyDZUVChTTWtGm4R40wMWGrTYwyUk0FDahs",
  authDomain: "sklepaga-8790e.firebaseapp.com",
  projectId: "sklepaga-8790e",
  storageBucket: "sklepaga-8790e.firebasestorage.app",
  messagingSenderId: "815409129057",
  appId: "1:815409129057:web:9f6342be47e28c1f69ec20",
  measurementId: "G-9GH707G2WZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- Admin account ---
const admin = {
  name: "Dzey Autajay",
  email: "autajaydzey@gmail.com",
  avatarColor: "#3498DB",
  avatarLetter: "D",
  uid: "yX0rfptwb2SKESPuPBzvfkv8gti2"
};

// --- Escape HTML ---
function escapeHtml(text) {
  if (!text) return "";
  return text.replace(/&/g, "&amp;").replace(/</g, "&lt;")
             .replace(/>/g, "&gt;").replace(/"/g, "&quot;")
             .replace(/'/g, "&#39;");
}

// --- DOM Elements ---
const userList = document.getElementById("userList");
const modalOverlay = document.getElementById("modalOverlay");
const closeModalBtn = document.getElementById("closeModalBtn");
const messagesContainer = document.getElementById("messagesContainer");
const replyForm = document.getElementById("replyForm");
const replyInput = document.getElementById("replyInput");
const modalTitle = document.getElementById("modalTitle");
const modalEmail = document.getElementById("modalEmail");

let currentConversationId = null;
let unsubscribeModalListener = null;

// --- Close modal ---
function closeModal() {
  modalOverlay.classList.add("hidden");
  modalOverlay.classList.remove("flex");
  currentConversationId = null;
  messagesContainer.innerHTML = "";
  if (unsubscribeModalListener) unsubscribeModalListener();
  unsubscribeModalListener = null;
}
closeModalBtn.addEventListener("click", closeModal);

// --- Render message in modal ---
function addMessage(author, text, time, isAdmin=false) {
  const msgDiv = document.createElement("div");
  msgDiv.className = `flex ${isAdmin ? "justify-start" : "justify-end"}`;
  msgDiv.innerHTML = `
    <div class="max-w-xs md:max-w-md p-3 rounded-lg mb-2 ${isAdmin?"bg-indigo-50 text-left":"bg-indigo-600 text-white text-right"}">
      <strong>${escapeHtml(author)}</strong><br/>
      ${escapeHtml(text)}<br/>
      <span class="text-xs text-gray-500">${escapeHtml(time)}</span>
    </div>
  `;
  messagesContainer.appendChild(msgDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// --- Open conversation modal ---
function openConversation(conversationId, userName, userEmail) {
  currentConversationId = conversationId;
  modalTitle.textContent = userName;
  modalEmail.textContent = userEmail;

  // Real-time listener
  if (unsubscribeModalListener) unsubscribeModalListener();
  unsubscribeModalListener = onSnapshot(doc(db, "message", conversationId), docSnap=>{
    if(!docSnap.exists()) return;
    messagesContainer.innerHTML = "";
    const data = docSnap.data();
    addMessage(data.name, data.message, data.time, data.name===admin.name);
    (data.replies || []).sort((a,b)=>new Date(a.time)-new Date(b.time)).forEach(r=>{
      addMessage(r.author, r.text, r.time, r.author===admin.name);
    });
    modalOverlay.classList.remove("hidden");
    modalOverlay.classList.add("flex");
    replyInput.focus();
  });
}

// --- Load all user conversations ---
function loadUsers() {
  const q = query(collection(db, "message"), orderBy("time","desc"));
  onSnapshot(q, snapshot=>{
    userList.innerHTML = "";
    if(snapshot.empty){
      userList.innerHTML = `<p class="text-gray-500 p-2">No conversations yet.</p>`;
      return;
    }

    const userConversations = {};

    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      // Use the user's email as key, always the other person
      const userEmail = data.userEmail || data.email || "unknown";
      if(!userConversations[userEmail]) userConversations[userEmail] = [];
      userConversations[userEmail].push({id: docSnap.id, data});
    });

    // Render only the latest conversation per user
    Object.values(userConversations).forEach(convArr=>{
      convArr.sort((a,b)=>{
        const lastA = a.data.replies?.length?a.data.replies[a.data.replies.length-1].time:a.data.time;
        const lastB = b.data.replies?.length?b.data.replies[b.data.replies.length-1].time:b.data.time;
        return new Date(lastB) - new Date(lastA);
      });

      const latestConv = convArr[0];
      const userName = latestConv.data.userName || latestConv.data.name || "Unknown";
      const userEmail = latestConv.data.userEmail || latestConv.data.email || "unknown@example.com";

      const lastMessage = latestConv.data.replies?.length 
                          ? latestConv.data.replies[latestConv.data.replies.length-1].text 
                          : latestConv.data.message;
      const lastTime = latestConv.data.replies?.length 
                       ? latestConv.data.replies[latestConv.data.replies.length-1].time 
                       : latestConv.data.time;

      const li = document.createElement("div");
      li.className = "p-3 border-b cursor-pointer hover:bg-gray-50";
      li.innerHTML = `
        <strong>${escapeHtml(userName)}</strong><br/>
        <span class="text-gray-500 text-sm">${escapeHtml(lastMessage)}</span><br/>
        <span class="text-gray-400 text-xs">${escapeHtml(lastTime)}</span>
      `;
      li.addEventListener("click", ()=>openConversation(latestConv.id, userName, userEmail));
      userList.appendChild(li);
    });
  });
}


loadUsers();

// --- Send reply ---
replyForm.addEventListener("submit", async e=>{
  e.preventDefault();
  if(!currentConversationId) return;
  const text = replyInput.value.trim();
  if(!text) return;
  const now = new Date().toLocaleString("en-PH", { timeZone:"Asia/Manila" }).replace(",", "");
  const reply = { author:admin.name, text, status:"unread", time: now };
  try {
    await updateDoc(doc(db,"message",currentConversationId), { replies: arrayUnion(reply) });
    replyInput.value = "";
  } catch(err){
    alert("Failed to send reply: "+err.message);
  }
});
</script>
</head>
<body class="bg-gray-50 p-4 min-h-screen">

  <h1 class="text-3xl font-bold mb-4 text-center">Admin Messages</h1>

  <!-- Users List -->
  <div id="userList" class="max-w-4xl mx-auto border rounded bg-white overflow-y-auto max-h-[70vh]"></div>

  <!-- Modal -->
  <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white max-w-3xl w-full max-h-[90vh] overflow-y-auto rounded-lg shadow-lg p-6 relative flex flex-col">
      <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 text-xl font-bold">&times;</button>
      <h2 class="text-2xl font-bold" id="modalTitle"></h2>
      <p class="text-gray-500 mb-4" id="modalEmail"></p>
      <div id="messagesContainer" class="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-50 border rounded mb-4"></div>
      <form id="replyForm" class="flex space-x-2">
        <input id="replyInput" type="text" placeholder="Type your reply..." class="flex-grow border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded">Send</button>
      </form>
    </div>
  </div>

</body>
</html>
