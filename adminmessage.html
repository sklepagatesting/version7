<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 font-sans">

<div class="max-w-md mx-auto bg-white shadow-lg rounded-lg overflow-hidden mt-10">
    <div class="p-4 border-b border-gray-200">
        <h2 class="text-lg font-bold text-gray-800">Admin Conversations</h2>
    </div>
    <div id="conversation-list" class="divide-y divide-gray-200 min-h-[100px]">
        <p id="loading-message" class="p-4 text-center text-gray-500">Loading conversations...</p>
    </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDZUVChTTWtGm4R40wMWGrTYwyUk0FDahs",
    authDomain: "sklepaga-8790e.firebaseapp.com",
    projectId: "sklepaga-8790e",
    storageBucket: "sklepaga-8790e.appspot.com",
    messagingSenderId: "815409129057",
    appId: "1:815409129057:web:9f6342be47e28c1f69ec20",
    measurementId: "G-9GH707G2WZ"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const adminUID = "yX0rfptwb2SKESPuPBzvfkv8gti2";

  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      console.log("No user logged in. Redirecting...");
      window.location.href = "messages.html";
      return;
    }

    // Confirm admin
    if (user.uid !== adminUID) {
      console.log("User is not admin. Redirecting...");
      window.location.href = "messages.html";
      return;
    }

    loadConversations();
  });

  async function loadConversations() {
    const container = document.getElementById("conversation-list");
    const loadingMessage = document.getElementById("loading-message");
    loadingMessage.style.display = "block";

    try {
      // Fetch accounts once
      const accountsSnapshot = await db.collection("accounts").get();
      const usersMap = {};
      accountsSnapshot.forEach(doc => {
        usersMap[doc.id] = doc.data().username || "Unknown User";
      });

      // Listen to all conversations with admin
      db.collection("conversations")
        .where("participants", "array-contains", adminUID)
        .orderBy("time","desc")
        .onSnapshot(snapshot => {
          loadingMessage.style.display = "none";
          container.innerHTML = "";

          if (snapshot.empty) {
            container.innerHTML = `<p class="p-4 text-center text-gray-500">No conversations found.</p>`;
            return;
          }

          snapshot.docs.forEach(docSnap => {
            const data = docSnap.data();
            const conversationId = docSnap.id;

            // Find the other user
            const participants = Array.isArray(data.participants) ? data.participants : [];
            const otherUserUID = participants.find(uid => uid !== adminUID) || "Unknown";
            const otherUserName = usersMap[otherUserUID] || otherUserUID;

            // Last message and timestamp
            const lastMessage = data.lastMessage || "No messages yet.";
            let timestamp = "";
            if (data.time) {
              try {
                if (data.time.toDate) timestamp = new Date(data.time.toDate()).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
                else timestamp = new Date(data.time).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
              } catch { timestamp = ""; }
            }

            const div = document.createElement("div");
            div.className = "p-4 hover:bg-gray-50 cursor-pointer transition-colors duration-200";
            div.innerHTML = `
              <div class="flex justify-between items-center">
                <span class="font-semibold text-gray-900">${otherUserName}</span>
                <span class="text-xs text-gray-500">${timestamp}</span>
              </div>
              <p class="text-gray-600 text-sm truncate mt-1">${lastMessage}</p>
            `;
            div.onclick = () => window.location.href = `adminchat.html?id=${conversationId}`;
            container.appendChild(div);
          });
        }, error => {
          console.error("Error loading conversations:", error);
          container.innerHTML = `<p class="p-4 text-center text-red-500">Error loading conversations. Check console.</p>`;
        });

    } catch (err) {
      console.error("Error fetching accounts:", err);
      loadingMessage.style.display = "none";
      container.innerHTML = `<p class="p-4 text-center text-red-500">Error fetching accounts. Check console.</p>`;
    }
  }
</script>

</body>
</html>
