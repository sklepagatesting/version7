<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #f5f5f5;
    }
    .truncate-single {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-bubble {
      max-width: 75%;
      padding: 8px 12px;
      border-radius: 12px;
      margin-bottom: 6px;
    }
    .chat-left {
      background-color: #e5e5ea;
      color: black;
      align-self: flex-start;
    }
    .chat-right {
      background-color: #0084ff;
      color: white;
      align-self: flex-end;
    }
  </style>
</head>
<body class="font-sans antialiased flex h-screen">

  <!-- Sidebar: Conversations -->
  <div class="w-1/3 bg-white shadow overflow-y-auto border-r">
    <div class="p-4 font-semibold text-lg border-b">Admin Conversations</div>
    <ul id="conversationsList" class="divide-y"></ul>
  </div>

  <!-- Main Chat Area -->
  <div class="flex-1 flex flex-col bg-gray-100">
    <div id="chatHeader" class="p-4 bg-white shadow text-lg font-semibold border-b">Select a conversation</div>
    <div id="chatMessages" class="flex-1 p-4 overflow-y-auto flex flex-col space-y-2"></div>
    <div class="p-4 bg-white border-t">
      <form id="messageForm" class="flex gap-2">
        <input id="messageInput" type="text" placeholder="Type a message..." class="flex-1 border rounded px-3 py-2 focus:outline-none" />
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Send</button>
      </form>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyDZUVChTTWtGm4R40wMWGrTYwyUk0FDahs",
      authDomain: "sklepaga-8790e.firebaseapp.com",
      projectId: "sklepaga-8790e",
      storageBucket: "sklepaga-8790e.appspot.com",
      messagingSenderId: "815409129057",
      appId: "1:815409129057:web:9f6342be47e28c1f69ec20",
      measurementId: "G-9GH707G2WZ"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentConversationId = null;

    // --- Load Conversations ---
    function loadConversations() {
      db.collection("conversations")
        .orderBy("timestamp", "desc")
        .onSnapshot((snapshot) => {
          const list = document.getElementById("conversationsList");
          list.innerHTML = "";
          snapshot.forEach((doc) => {
            const convo = doc.data();
            const li = document.createElement("li");
            li.className = "p-3 hover:bg-gray-100 cursor-pointer";
            li.innerHTML = `
              <div class="truncate-single font-medium">${convo.name || "Unnamed"}</div>
              <div class="text-sm text-gray-500">${convo.lastMessage || "(No messages yet)"}</div>
            `;
            li.addEventListener("click", () => openConversation(doc.id, convo.name));
            list.appendChild(li);
          });
        });
    }

    // --- Open Conversation ---
    function openConversation(convoId, name) {
      currentConversationId = convoId;
      document.getElementById("chatHeader").textContent = name || "Conversation";
      const chatMessages = document.getElementById("chatMessages");
      chatMessages.innerHTML = "";

      db.collection("conversations")
        .doc(convoId)
        .collection("messages")
        .orderBy("time", "asc")
        .onSnapshot((snapshot) => {
          chatMessages.innerHTML = "";
          snapshot.forEach((doc) => {
            const msg = doc.data();
            const div = document.createElement("div");
            div.className = `chat-bubble ${msg.author === "admin" ? "chat-right" : "chat-left"}`;
            div.innerHTML = `<div>${msg.text}</div><div class="text-xs opacity-70 mt-1">${msg.time}</div>`;
            chatMessages.appendChild(div);
          });
          chatMessages.scrollTop = chatMessages.scrollHeight;
        });
    }

    // --- Send Message ---
    document.getElementById("messageForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (!text || !currentConversationId) return;

      await db.collection("conversations")
        .doc(currentConversationId)
        .collection("messages")
        .add({
          text: text,
          author: "admin",
          time: new Date().toLocaleString(),
          status: "sent"
        });

      input.value = "";
    });

    // Init
    loadConversations();
  </script>
</body>
</html>
