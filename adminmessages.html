<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>User Messages</title>
  <link rel="stylesheet" href="font/font.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --sender-bg: #DCF8C6;
      --receiver-bg: #FFFFFF;
    }
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">

  <!-- Header -->
  <header class="bg-blue-600 text-white p-4 text-lg font-semibold shadow">
    Messages
  </header>

  <!-- Messages container -->
  <main id="messages" class="flex-1 overflow-y-auto p-4 space-y-4">
    <!-- Messages will load here -->
  </main>

  <!-- Input box -->
  <footer class="p-4 bg-white flex items-center shadow">
    <input 
      id="messageInput" 
      type="text" 
      placeholder="Type a message..." 
      class="flex-1 border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
    >
    <button 
      id="sendBtn" 
      class="ml-2 bg-blue-600 text-white px-4 py-2 rounded-full hover:bg-blue-700 transition">
      Send
    </button>
  </footer>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getFirestore, doc, getDoc, addDoc, collection, query, orderBy, onSnapshot 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { 
      getAuth, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // --- Firebase Config (replace with yours) ---
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const messagesContainer = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");

    // --- Auth check ---
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html"; // not logged in
        return;
      }

      // ðŸ” Check if user is admin
      const adminRef = doc(db, "admins", user.uid);
      const adminSnap = await getDoc(adminRef);

      if (adminSnap.exists()) {
        // redirect admins
        window.location.href = "adminmessage.html";
        return;
      }

      // --- Listen to messages (normal user) ---
      const q = query(collection(db, "messages"), orderBy("timestamp"));
      onSnapshot(q, (snapshot) => {
        messagesContainer.innerHTML = "";
        snapshot.forEach((doc) => {
          const msg = doc.data();
          const div = document.createElement("div");
          div.className = msg.uid === user.uid 
            ? "text-right" 
            : "text-left";
          div.innerHTML = `
            <div class="inline-block px-4 py-2 rounded-2xl shadow ${msg.uid === user.uid ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-900'}">
              ${msg.text}
            </div>
          `;
          messagesContainer.appendChild(div);
        });
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      });

      // --- Send message ---
      sendBtn.addEventListener("click", async () => {
        const text = messageInput.value.trim();
        if (!text) return;
        await addDoc(collection(db, "messages"), {
          text,
          uid: user.uid,
          timestamp: new Date()
        });
        messageInput.value = "";
      });
    });
  </script>
</body>
</html>