<!DOCTYPE html>
<html lang="en" class="bg-gray-100 dark:bg-gray-900">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gemini Chat</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
    import { marked } from "https://esm.run/marked";

    const firebaseConfig = {
      apiKey: "AIzaSyDZUVChTTWtGm4R40wMWGrTYwyUk0FDahs",
      authDomain: "sklepaga-8790e.firebaseapp.com",
      projectId: "sklepaga-8790e",
      storageBucket: "sklepaga-8790e.appspot.com",
      messagingSenderId: "815409129057",
      appId: "1:815409129057:web:9f6342be47e28c1f69ec20",
      measurementId: "G-9GH707G2WZ"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let GEMINI_API_KEY = null;
    let genAI = null;

    // Elements
    const loader = document.getElementById("loader");
    const apiForm = document.getElementById("api-form");
    const chatContainer = document.getElementById("chat-container");
    const apiInput = document.getElementById("api-key-input");
    const saveBtn = document.getElementById("save-api-btn");
    const outputDiv = document.getElementById("output");
    const inputTextArea = document.getElementById("input");

    // ðŸ”¹ Check if API key is already stored
    async function checkApiKey() {
      const doc = await db.collection("config").doc("gemini").get();
      if (doc.exists && doc.data().key) {
        GEMINI_API_KEY = doc.data().key;
        genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
        return true;
      }
      return false;
    }

    // ðŸ”¹ Save API key to shared collection
    async function saveApiKey(key) {
      await db.collection("config").doc("gemini").set({ key });
      GEMINI_API_KEY = key;
      genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
    }

    // ðŸ”¹ Send prompt to Gemini
    async function sendPrompt(promptText) {
      if (!genAI) return alert("No API key set!");

      // Show a loading state
      outputDiv.innerHTML = '<p class="text-gray-500 animate-pulse">Generating response...</p>';

      try {
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
        const result = await model.generateContent(promptText);
        const responseText = result.response.text();

        // Parse and render the Markdown output
        outputDiv.innerHTML = marked.parse(responseText);

      } catch (error) {
        console.error("Error generating content:", error);
        outputDiv.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
      }
    }

    // ðŸ”¹ Initialize
    (async () => {
      loader.classList.remove("hidden");
      const hasKey = await checkApiKey();
      loader.classList.add("hidden");

      if (hasKey) {
        chatContainer.classList.remove("hidden");
      } else {
        apiForm.classList.remove("hidden");
      }

      saveBtn.addEventListener("click", async () => {
        const key = apiInput.value.trim();
        if (!key) return alert("Please enter a valid API key.");
        await saveApiKey(key);
        apiForm.classList.add("hidden");
        chatContainer.classList.remove("hidden");
      });
      
      inputTextArea.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendPrompt(inputTextArea.value);
        }
      });
    })();

    window.sendPrompt = sendPrompt;
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex flex-col items-center justify-start min-h-screen p-6">
  <div id="loader" class="hidden text-gray-700 dark:text-gray-300 text-lg">ðŸ”‘ Checking API key...</div>

  <div id="api-form" class="hidden w-full max-w-md flex flex-col gap-4 items-center p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md">
    <h2 class="text-xl font-semibold text-gray-800 dark:text-white">Enter Gemini API Key</h2>
    <input type="text" id="api-key-input" placeholder="API Key" class="w-full p-3 border rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
    <button id="save-api-btn" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Save API Key</button>
  </div>

  <div id="chat-container" class="hidden w-full max-w-xl flex flex-col gap-4">
    <h1 class="text-2xl font-bold text-gray-800 dark:text-white text-center">ðŸ”¥ Gemini Chat ðŸ”¥</h1>
    
    <textarea id="input" placeholder="Type something..." class="w-full p-3 border rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4"></textarea>
    
    <button onclick="sendPrompt(document.getElementById('input').value)" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Send</button>
    
    <div id="output" class="p-4 border rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-gray-100 whitespace-pre-wrap"></div>
  </div>
</body>
</html>
