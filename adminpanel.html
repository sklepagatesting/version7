<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, getDoc, doc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyDZUVChTTWtGm4R40wMWGrTYwyUk0FDahs",
      authDomain: "sklepaga-8790e.firebaseapp.com",
      projectId: "sklepaga-8790e",
      storageBucket: "sklepaga-8790e.firebasestorage.app",
      messagingSenderId: "815409129057",
      appId: "1:815409129057:web:9f6342be47e28c1f69ec20",
      measurementId: "G-9GH707G2WZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let activeAccount = JSON.parse(localStorage.getItem("activeAdmin") || "{}");

    async function verifyAccess() {
      // --- Case 1: No account at all ---
      if (!activeAccount.uid) {
        window.location.href = "authentication.html";
        return;
      }

      // --- Case 2: Check if account exists in admin collection ---
      const adminDoc = await getDoc(doc(db, "admin", activeAccount.uid));
      if (!adminDoc.exists()) {
        // Not an admin → redirect to messages
        window.location.href = "messages.html";
        return;
      }

      const adminData = adminDoc.data();

      // --- Ask for password before showing ---
      let pass = prompt("Enter admin password:");
      if (pass !== adminData.password) {
        alert("Incorrect password.");
        window.location.href = "authentication.html";
        return;
      }

      // If password correct → load panel
      loadAdmins();
      loadUsers();
    }

    async function loadAdmins() {
      const adminList = document.getElementById("adminList");
      adminList.innerHTML = "";
      const snapshot = await getDocs(collection(db, "admin"));
      snapshot.forEach(docSnap => {
        const admin = docSnap.data();
        const div = document.createElement("div");
        div.className = "flex justify-between items-center border-b py-2";
        div.innerHTML = `
          <div>
            <div class="font-semibold">${admin.name}</div>
            <div class="text-sm text-gray-500">${admin.email}</div>
          </div>
          <button onclick="promptUpdatePassword('${admin.uid}')" class="text-blue-500 hover:underline">Update Password</button>
        `;
        adminList.appendChild(div);
      });
    }

    async function loadUsers() {
      const userList = document.getElementById("userList");
      userList.innerHTML = "";
      const snapshot = await getDocs(collection(db, "accounts"));
      snapshot.forEach(docSnap => {
        const user = docSnap.data();
        const div = document.createElement("div");
        div.className = "flex justify-between items-center border-b py-2";
        div.innerHTML = `
          <div>
            <div class="font-semibold">${user.name}</div>
            <div class="text-sm text-gray-500">${user.email}</div>
          </div>
          <div class="flex gap-3">
            <button onclick="promoteUser('${user.uid}')" class="text-green-600 hover:underline">Add as Admin</button>
            <button onclick="deleteUser('${user.uid}')" class="text-red-600 hover:underline">Delete</button>
          </div>
        `;
        userList.appendChild(div);
      });
    }

    // --- Admin actions ---
    async function promptUpdatePassword(uid) {
      const newPass = prompt("Enter new password:");
      if (!newPass) return;
      try {
        await updateDoc(doc(db, "admin", uid), { password: newPass });
        alert("Password updated.");
      } catch (e) {
        alert("Failed to update password: " + e.message);
      }
    }

    async function deleteUser(uid) {
      if (!confirm("Are you sure you want to delete this user?")) return;
      try {
        await deleteDoc(doc(db, "accounts", uid));
        loadUsers();
        alert("User deleted.");
      } catch (e) {
        alert("Failed to delete user: " + e.message);
      }
    }

    async function promoteUser(uid) {
      const pass = prompt("Enter initial password for this new admin:");
      if (!pass) return;

      try {
        const snapshot = await getDocs(collection(db, "accounts"));
        let targetUser = null;
        snapshot.forEach(docSnap => {
          if (docSnap.id === uid) targetUser = docSnap.data();
        });

        if (!targetUser) {
          alert("User not found.");
          return;
        }

        const newAdmin = {
          ...targetUser,
          password: pass
        };

        await setDoc(doc(db, "admin", uid), newAdmin);
        alert("User promoted to admin.");
        loadAdmins();
      } catch (e) {
        alert("Failed to promote user: " + e.message);
      }
    }

    window.promptUpdatePassword = promptUpdatePassword;
    window.deleteUser = deleteUser;
    window.promoteUser = promoteUser;

    // Init
    window.addEventListener("DOMContentLoaded", () => {
      verifyAccess();
    });
  </script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg p-6">
    <h1 class="text-2xl font-bold mb-6">Admin Panel</h1>

    <h2 class="text-xl font-semibold mb-2">Admins</h2>
    <div id="adminList" class="mb-6 border rounded-lg p-3 bg-gray-50"></div>

    <h2 class="text-xl font-semibold mb-2">User Accounts</h2>
    <div id="userList" class="border rounded-lg p-3 bg-gray-50"></div>
  </div>
</body>
</html>
