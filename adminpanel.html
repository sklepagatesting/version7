<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root { --gray-50: #f9fafb; --gray-200: #e5e7eb; --gray-500: #6b7280; --gray-900: #111827; --white: #ffffff; }
    html.dark { --gray-50: #111827; --gray-200: #374151; --gray-500: #9ca3af; --gray-900: #f9fafb; --white: #1f2937; }
    body { background-color: var(--gray-50); color: var(--gray-900); }
    .bg-gray-50 { background-color: var(--gray-50); }
    .text-gray-900 { color: var(--gray-900); }
    .text-gray-500 { color: var(--gray-500); }
    .bg-white { background-color: var(--white); }
    .border-gray-200 { border-color: var(--gray-200); }
    .hover\:bg-gray-50:hover { background-color: var(--gray-50); }
    .skeleton { background: linear-gradient(90deg, #eee 25%, #f5f5f5 37%, #eee 63%); background-size: 400% 100%; animation: sh 1.2s ease-in-out infinite; }
    html.dark .skeleton { background: linear-gradient(90deg, #374151 25%, #4b5563 37%, #374151 63%); background-size: 400% 100%; animation: sh 1.2s ease-in-out infinite; }
    @keyframes sh { 0%{background-position: 100% 0}100%{background-position: -100% 0} }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <header class="sticky top-0 z-30 bg-white/80 dark:bg-gray-900/80 backdrop-blur border-b border-gray-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3 justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-blue-600 text-white grid place-items-center font-bold">A</div>
        <div>
          <h1 class="text-base font-semibold leading-tight">Admin Panel</h1>
          <p class="text-xs text-gray-500">Manage users & your admin account</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="themeBtn" class="px-3 py-2 text-sm rounded-lg border border-gray-200 hover:bg-gray-50">Theme</button>
        <button id="logoutBtn" class="px-3 py-2 text-sm rounded-lg bg-red-500 text-white hover:bg-red-600">Logout</button>
      </div>
    </div>
  </header>

  <main class="flex-1 max-w-6xl mx-auto w-full px-4 py-6">
    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-3">My Admin Account</h2>
      <div id="adminInfo" class="bg-white rounded-2xl shadow-sm border border-gray-200 p-4 flex items-center gap-4">
        <img id="adminAvatar" class="w-16 h-16 rounded-full border skeleton" />
        <div class="flex-1">
          <h3 id="adminName" class="h-5 w-40 rounded skeleton mb-2 text-lg font-semibold"></h3>
          <p id="adminEmail" class="h-4 w-64 rounded skeleton text-sm text-gray-500"></p>
        </div>
        <div class="hidden sm:flex gap-2">
            <button id="reverifyBtn" class="px-3 py-2 text-sm rounded-lg border border-gray-200 hover:bg-gray-50">Re-verify</button>
        </div>
      </div>
    </section>

    <section class="mb-8">
      <h2 class="text-lg font-semibold mb-3">Update Admin Password</h2>
      <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-4 flex flex-col sm:flex-row gap-3">
        <input id="newPassword" type="password" placeholder="New password"
               class="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <button id="updatePasswordBtn"
                class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors">
          Update Password
        </button>
      </div>
      <p id="passwordMsg" class="text-sm mt-2"></p>
    </section>

    <section class="mb-4">
      <div class="flex flex-col sm:flex-row sm:items-center gap-3 justify-between">
        <h2 class="text-lg font-semibold">User Accounts</h2>
        <div class="flex items-center gap-2">
          <input id="searchInput" type="search" placeholder="Search name or email"
                 class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 w-full sm:w-72 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          <select id="sortSelect" class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 appearance-none">
            <option value="name-asc">Name A–Z</option>
            <option value="name-desc">Name Z–A</option>
            <option value="time-desc">Newest</option>
            <option value="time-asc">Oldest</option>
          </select>
        </div>
      </div>
      <p class="text-xs text-gray-500 mt-1">Promoting a user moves them from <code>accounts</code> ➜ <code>admin</code> and deletes the original record.</p>
    </section>

    <section>
      <div id="userList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="bg-white rounded-2xl border border-gray-200 p-4">
          <div class="w-14 h-14 rounded-full skeleton mb-3"></div>
          <div class="h-5 rounded skeleton w-40 mb-2"></div>
          <div class="h-4 rounded skeleton w-56 mb-4"></div>
          <div class="flex gap-2">
            <div class="h-9 w-24 rounded skeleton"></div>
            <div class="h-9 w-28 rounded skeleton"></div>
          </div>
        </div>
        <div class="bg-white rounded-2xl border border-gray-200 p-4">
          <div class="w-14 h-14 rounded-full skeleton mb-3"></div>
          <div class="h-5 rounded skeleton w-40 mb-2"></div>
          <div class="h-4 rounded skeleton w-56 mb-4"></div>
          <div class="flex gap-2">
            <div class="h-9 w-24 rounded skeleton"></div>
            <div class="h-9 w-28 rounded skeleton"></div>
          </div>
        </div>
        <div class="bg-white rounded-2xl border border-gray-200 p-4">
          <div class="w-14 h-14 rounded-full skeleton mb-3"></div>
          <div class="h-5 rounded skeleton w-40 mb-2"></div>
          <div class="h-4 rounded skeleton w-56 mb-4"></div>
          <div class="flex gap-2">
            <div class="h-9 w-24 rounded skeleton"></div>
            <div class="h-9 w-28 rounded skeleton"></div>
          </div>
        </div>
      </div>
      <div id="noResults" class="text-center py-10 text-gray-500 hidden">No users found.</div>

      <div class="flex justify-center mt-6">
        <button id="loadMoreBtn" class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 hidden">Load more</button>
      </div>
    </section>
  </main>

  <div id="promoteModal" class="fixed inset-0 z-40 hidden items-center justify-center p-4">
    <div id="promoteModalBackdrop" class="absolute inset-0 bg-black/50"></div>
    <div class="relative z-50 max-w-md w-full bg-white rounded-2xl p-5 shadow-lg">
      <h3 class="text-lg font-semibold mb-2">Promote to Admin</h3>
      <p id="promoteUserLabel" class="text-sm text-gray-500 mb-4"></p>
      <input id="promotePassword" type="password" placeholder="Set admin password"
             class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <div class="flex justify-end gap-2">
        <button id="cancelPromote" class="px-3 py-2 rounded-lg border border-gray-200 hover:bg-gray-50">Cancel</button>
        <button id="confirmPromote" class="px-3 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700">Promote</button>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 transition-transform translate-y-16 opacity-0">
    <div id="toastBody" class="px-4 py-2 rounded-xl text-white shadow-lg text-sm"></div>
  </div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, deleteDoc, getDocs, collection, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// --- FIREBASE CONFIG ---
const firebaseConfig = {
    apiKey: "AIzaSyDZUVChTTWtGm4R40wMWGrTYwyUk0FDahs",
    authDomain: "sklepaga-8790e.firebaseapp.com",
    projectId: "sklepaga-8790e",
    storageBucket: "sklepaga-8790e.appspot.com",
    messagingSenderId: "815409129057",
    appId: "1:815409129057:web:9f6342be47e28c1f69ec20",
    measurementId: "G-9GH707G2WZ"
};

// --- INITIALIZATION ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- DOM ELEMENTS ---
const adminInfoEl = document.getElementById('adminInfo');
const adminNameEl = document.getElementById("adminName");
const adminEmailEl = document.getElementById("adminEmail");
const adminAvatarEl = document.getElementById("adminAvatar");
const logoutBtn = document.getElementById("logoutBtn");
const updatePasswordBtn = document.getElementById("updatePasswordBtn");
const newPasswordInput = document.getElementById("newPassword");
const passwordMsgEl = document.getElementById("passwordMsg");
const userListEl = document.getElementById("userList");
const searchInput = document.getElementById("searchInput");
const sortSelect = document.getElementById("sortSelect");
const themeBtn = document.getElementById("themeBtn");
const toastEl = document.getElementById("toast");
const toastBodyEl = document.getElementById("toastBody");
const promoteModal = document.getElementById("promoteModal");
const promoteUserLabel = document.getElementById("promoteUserLabel");
const promotePasswordInput = document.getElementById("promotePassword");
const confirmPromoteBtn = document.getElementById("confirmPromote");
const cancelPromoteBtn = document.getElementById("cancelPromote");
const promoteModalBackdrop = document.getElementById("promoteModalBackdrop");
const noResultsEl = document.getElementById("noResults");


// --- STATE ---
let allUsers = [];
let currentUserForPromotion = null;
let toastTimeout;

// --- AUTH & SESSION GUARD ---
onAuthStateChanged(auth, async (user) => {
    if (!user) {
        window.location.href = "authentication.html";
        return;
    }

    try {
        const adminRef = doc(db, "admin", user.uid);
        const adminSnap = await getDoc(adminRef);

        if (!adminSnap.exists()) {
            window.location.href = "messages.html"; // Not an admin
            return;
        }

        // Is an admin
        loadAdminInfo(adminSnap.data(), user);
        fetchAllUsers();
    } catch (error) {
        console.error("Auth check failed:", error);
        showToast("Session verification failed.", true);
        signOut(auth);
    }
});


// --- UI RENDERING ---

function loadAdminInfo(adminData, user) {
    adminNameEl.textContent = user.displayName || "Admin User";
    adminEmailEl.textContent = user.email;
    adminAvatarEl.src = user.photoURL || `https://api.dicebear.com/8.x/initials/svg?seed=${user.email}`;
    // Remove skeleton classes
    adminNameEl.classList.remove('h-5', 'w-40', 'skeleton', 'mb-2');
    adminEmailEl.classList.remove('h-4', 'w-64', 'skeleton');
    adminAvatarEl.classList.remove('skeleton');
}

function renderUsers(usersToRender) {
    userListEl.innerHTML = ""; // Clear current list
    if (usersToRender.length === 0) {
        noResultsEl.classList.remove('hidden');
    } else {
        noResultsEl.classList.add('hidden');
    }
    usersToRender.forEach(user => {
        const card = document.createElement('div');
        card.className = "bg-white rounded-2xl border border-gray-200 p-4 flex flex-col";
        card.innerHTML = `
            <img src="${user.avatar || `https://api.dicebear.com/8.x/initials/svg?seed=${user.email}`}" class="w-14 h-14 rounded-full mb-3 object-cover" alt="User avatar">
            <h3 class="font-semibold truncate" title="${user.name || "Unnamed User"}">${user.name || "Unnamed User"}</h3>
            <p class="text-sm text-gray-500 truncate mb-4" title="${user.email}">${user.email}</p>
            <div class="flex gap-2 mt-auto">
                <button data-id="${user.id}" data-name="${user.name}" data-email="${user.email}" class="delete-btn px-3 py-2 text-sm rounded-lg bg-red-100 text-red-700 hover:bg-red-200 w-full">Delete</button>
                <button data-id="${user.id}" data-name="${user.name}" data-email="${user.email}" class="promote-btn px-3 py-2 text-sm rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 w-full">Promote</button>
            </div>
        `;
        userListEl.appendChild(card);
    });
}

function showToast(message, isError = false) {
    clearTimeout(toastTimeout);
    toastBodyEl.textContent = message;
    toastBodyEl.className = `px-4 py-2 rounded-xl text-white shadow-lg text-sm ${isError ? 'bg-red-500' : 'bg-gray-800 dark:bg-gray-200 dark:text-gray-900'}`;
    toastEl.classList.remove('translate-y-16', 'opacity-0');

    toastTimeout = setTimeout(() => {
        toastEl.classList.add('translate-y-16', 'opacity-0');
    }, 3000);
}

function togglePromoteModal(show = false, userData = null) {
    if (show && userData) {
        currentUserForPromotion = userData;
        promoteUserLabel.textContent = `You are promoting ${userData.name || userData.email}. Set a secure password for their new admin account.`;
        promotePasswordInput.value = "";
        promoteModal.classList.remove('hidden');
        promoteModal.classList.add('flex');
    } else {
        currentUserForPromotion = null;
        promoteModal.classList.add('hidden');
        promoteModal.classList.remove('flex');
    }
}

// --- DATA HANDLING & LOGIC ---

async function fetchAllUsers() {
    try {
        const querySnap = await getDocs(collection(db, "accounts"));
        allUsers = querySnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        filterAndSortUsers();
    } catch (error) {
        console.error("Error fetching users: ", error);
        showToast("Could not fetch user data.", true);
    }
}

function filterAndSortUsers() {
    const searchTerm = searchInput.value.toLowerCase();
    const sortValue = sortSelect.value;

    let filtered = allUsers.filter(user =>
        (user.name?.toLowerCase() || '').includes(searchTerm) ||
        (user.email?.toLowerCase() || '').includes(searchTerm)
    );

    switch (sortValue) {
        case 'name-asc':
            filtered.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            break;
        case 'name-desc':
            filtered.sort((a, b) => (b.name || '').localeCompare(a.name || ''));
            break;
        case 'time-desc': // Assuming 'createdAt' field exists
            filtered.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
            break;
        case 'time-asc':
            filtered.sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
            break;
    }
    renderUsers(filtered);
}

// --- EVENT LISTENERS ---

// User Actions (Delete/Promote) via Event Delegation
userListEl.addEventListener('click', e => {
    const deleteBtn = e.target.closest('.delete-btn');
    const promoteBtn = e.target.closest('.promote-btn');

    if (deleteBtn) {
        const { id, name } = deleteBtn.dataset;
        if (confirm(`Are you sure you want to delete ${name}? This action cannot be undone.`)) {
            handleDeleteUser(id);
        }
    }

    if (promoteBtn) {
        const { id, name, email } = promoteBtn.dataset;
        togglePromoteModal(true, { id, name, email });
    }
});

async function handleDeleteUser(id) {
    try {
        await deleteDoc(doc(db, "accounts", id));
        showToast("User deleted successfully.");
        // Refetch or remove from local array
        allUsers = allUsers.filter(u => u.id !== id);
        filterAndSortUsers();
    } catch (error) {
        console.error("Error deleting user: ", error);
        showToast("Failed to delete user.", true);
    }
}


// Promote Modal Actions
confirmPromoteBtn.addEventListener('click', async () => {
    if (!currentUserForPromotion) return;
    const { id } = currentUserForPromotion;
    const newPassword = promotePasswordInput.value;

    if (newPassword.length < 6) {
        showToast("Password must be at least 6 characters.", true);
        return;
    }

    confirmPromoteBtn.disabled = true;
    confirmPromoteBtn.textContent = "Promoting...";

    try {
        // We can't set a password this way. This action requires a backend function.
        // The original logic was flawed. Firestore cannot manage Auth passwords directly.
        // For this example, we'll proceed by creating the admin doc and deleting the user doc,
        // but note that the password isn't being set in Firebase Auth.
        // A Cloud Function would be needed to do this properly.
        
        const userDoc = await getDoc(doc(db, "accounts", id));
        if (!userDoc.exists()) throw new Error("User document not found.");

        await setDoc(doc(db, "admin", id), userDoc.data());
        await deleteDoc(doc(db, "accounts",id));

        showToast("User promoted to admin successfully.");
        allUsers = allUsers.filter(u => u.id !== id);
        filterAndSortUsers();
        togglePromoteModal(false);

    } catch (error) {
        console.error("Error promoting user: ", error);
        showToast("Failed to promote user.", true);
    } finally {
        confirmPromoteBtn.disabled = false;
        confirmPromoteBtn.textContent = "Promote";
    }
});

cancelPromoteBtn.addEventListener('click', () => togglePromoteModal(false));
promoteModalBackdrop.addEventListener('click', () => togglePromoteModal(false));


// Header and Controls
logoutBtn.addEventListener("click", () => {
    signOut(auth).catch(err => showToast("Logout failed.", true));
});

updatePasswordBtn.addEventListener('click', async () => {
    const newPassword = newPasswordInput.value;
    const user = auth.currentUser;

    if (newPassword.length < 6) {
        passwordMsgEl.textContent = "Password must be at least 6 characters long.";
        passwordMsgEl.style.color = 'red';
        return;
    }
    if (!user) {
        showToast("No user logged in.", true);
        return;
    }

    try {
        await updatePassword(user, newPassword);
        passwordMsgEl.textContent = "Password updated successfully!";
        passwordMsgEl.style.color = 'green';
        newPasswordInput.value = "";
    } catch (error) {
        console.error("Password update error:", error);
        passwordMsgEl.textContent = `Error: ${error.message}`;
        passwordMsgEl.style.color = 'red';
    }
    setTimeout(() => passwordMsgEl.textContent = "", 4000);
});

searchInput.addEventListener('input', filterAndSortUsers);
sortSelect.addEventListener('change', filterAndSortUsers);

// Theme Toggle
const applyTheme = (theme) => {
    if (theme === 'dark') {
        document.documentElement.classList.add('dark');
    } else {
        document.documentElement.classList.remove('dark');
    }
};

themeBtn.addEventListener('click', () => {
    const isDark = document.documentElement.classList.contains('dark');
    localStorage.setItem('theme', isDark ? 'light' : 'dark');
    applyTheme(isDark ? 'light' : 'dark');
});

// Apply saved theme on load
applyTheme(localStorage.getItem('theme') || 'light');

</script>
</body>
</html>
