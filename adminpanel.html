<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">Admin Panel</h1>
    <button id="logoutBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Logout</button>
  </header>

  <!-- Main Content -->
  <main class="flex-1 p-6 space-y-6">
    <!-- Admin Info -->
    <section id="adminInfo" class="bg-white p-4 rounded-2xl shadow flex items-center gap-4">
      <div class="w-16 h-16 bg-gray-200 rounded-full animate-pulse"></div>
      <div class="flex-1 space-y-2">
        <div class="h-4 bg-gray-200 rounded w-32 animate-pulse"></div>
        <div class="h-4 bg-gray-200 rounded w-48 animate-pulse"></div>
      </div>
    </section>

    <!-- Update Password -->
    <section class="bg-white p-6 rounded-2xl shadow">
      <h2 class="text-lg font-semibold mb-4">Update Password</h2>
      <input id="newPassword" type="password" placeholder="New Password" 
             class="w-full p-2 border rounded-lg mb-3" />
      <button id="updatePasswordBtn" 
              class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
        Update Password
      </button>
    </section>

    <!-- Manage Users -->
    <section class="bg-white p-6 rounded-2xl shadow">
      <h2 class="text-lg font-semibold mb-4">Manage Users</h2>
      <div id="userList" class="space-y-3">
        <p class="text-gray-500">Loading users...</p>
      </div>
    </section>
  </main>

  <script>
    // Firebase config (replace with your project config)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Init
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM Refs
    const adminInfoEl = document.getElementById("adminInfo");
    const logoutBtn = document.getElementById("logoutBtn");
    const updatePasswordBtn = document.getElementById("updatePasswordBtn");
    const userList = document.getElementById("userList");

    // Session Guard
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "authentication.html";
        return;
      }

      const activeAdminId = localStorage.getItem("activeAdmin");
      if (!activeAdminId) {
        window.location.href = "authentication.html";
        return;
      }

      const adminRef = db.collection("admin").doc(activeAdminId);
      const adminSnap = await adminRef.get();

      if (!adminSnap.exists) {
        window.location.href = "messages.html";
        return;
      }

      loadAdminInfo(adminSnap.data(), user);
      loadUsers();
    });

    // Load Admin Info
    function loadAdminInfo(adminData, user) {
      adminInfoEl.innerHTML = `
        <img src="${user.photoURL || "default-avatar.png"}" 
             class="w-16 h-16 rounded-full border" />
        <div class="flex-1">
          <p class="text-lg font-semibold">${user.displayName || "Admin"}</p>
          <p class="text-sm text-gray-600">${user.email}</p>
        </div>
      `;
    }

    // Load Users
    async function loadUsers() {
      const accountsSnap = await db.collection("accounts").get();
      if (accountsSnap.empty) {
        userList.innerHTML = `<p class="text-gray-500">No users found.</p>`;
        return;
      }

      userList.innerHTML = "";
      accountsSnap.forEach(doc => {
        const user = doc.data();
        const div = document.createElement("div");
        div.className = "flex justify-between items-center p-3 border rounded-lg";
        div.innerHTML = `
          <div>
            <p class="font-semibold">${user.name || "Unnamed User"}</p>
            <p class="text-sm text-gray-600">${user.email}</p>
          </div>
          <div class="space-x-2">
            <button class="px-3 py-1 bg-red-500 text-white rounded deleteBtn">Delete</button>
            <button class="px-3 py-1 bg-green-500 text-white rounded promoteBtn">Promote</button>
          </div>
        `;

        // Delete
        div.querySelector(".deleteBtn").addEventListener("click", async () => {
          if (confirm("Delete this user?")) {
            await db.collection("accounts").doc(doc.id).delete();
            div.remove();
          }
        });

        // Promote
        div.querySelector(".promoteBtn").addEventListener("click", async () => {
          const password = prompt("Set an initial password for this new admin:");
          if (!password) return;

          await db.collection("admin").doc(doc.id).set({
            ...user,
            password
          });
          await db.collection("accounts").doc(doc.id).delete();
          div.remove();
          alert("User promoted to admin!");
        });

        userList.appendChild(div);
      });
    }

    // Update Password
    updatePasswordBtn.addEventListener("click", async () => {
      const activeAdminId = localStorage.getItem("activeAdmin");
      if (!activeAdminId) return;

      const newPass = document.getElementById("newPassword").value;
      if (!newPass) {
        alert("Enter a new password!");
        return;
      }

      await db.collection("admin").doc(activeAdminId).update({ password: newPass });
      alert("Password updated successfully!");
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      await auth.signOut();
      localStorage.removeItem("activeAdmin");
      window.location.href = "authentication.html";
    });
  </script>
</body>
</html>
