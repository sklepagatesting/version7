<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Messages</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, doc, onSnapshot, updateDoc, arrayUnion, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDZUVChTTWtGm4R40wMWGrTYwyUk0FDahs",
      authDomain: "sklepaga-8790e.firebaseapp.com",
      projectId: "sklepaga-8790e",
      storageBucket: "sklepaga-8790e.firebasestorage.app",
      messagingSenderId: "815409129057",
      appId: "1:815409129057:web:9f6342be47e28c1f69ec20",
      measurementId: "G-9GH707G2WZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Get current user from localStorage
    const account = JSON.parse(localStorage.getItem("account"));
    if (!account) window.location.href = "authentication.html";

    const userName = account.name;
    const userEmail = account.email;
    const userUid = account.uid;

    // DOM Elements
    const leftPanel = document.getElementById("conversationList");
    const rightPanel = document.getElementById("conversationThread");
    const replyForm = document.getElementById("replyForm");
    const replyInput = document.getElementById("replyInput");
    const selectedTitle = document.getElementById("selectedTitle");

    let currentConversationId = null;
    let unsubscribeThread = null;

    // Escape HTML
    function escapeHtml(text) {
      if (!text) return "";
      return text.replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#39;");
    }

    // Render left panel conversations
    const convRef = collection(db, "message");
    onSnapshot(convRef, snapshot => {
      leftPanel.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const convDiv = document.createElement("div");
        convDiv.className = "p-4 border-b hover:bg-gray-50 cursor-pointer";
        const latestReply = data.replies?.length ? data.replies[data.replies.length-1].text : data.message;
        convDiv.innerHTML = `
          <div class="flex justify-between">
            <span class="font-semibold">${escapeHtml(data.name)}</span>
            <span class="text-xs text-gray-500">${escapeHtml(data.time)}</span>
          </div>
          <div class="text-gray-600 text-sm truncate">${escapeHtml(latestReply)}</div>
        `;
        convDiv.addEventListener("click", () => openConversation(docSnap.id, data));
        leftPanel.appendChild(convDiv);
      });
    });

    function openConversation(id, data) {
      currentConversationId = id;
      selectedTitle.textContent = data.name;

      if (unsubscribeThread) unsubscribeThread();

      const threadRef = doc(db, "message", id);
      unsubscribeThread = onSnapshot(threadRef, docSnap => {
        const convData = docSnap.data();
        rightPanel.innerHTML = "";

        // Main message
        const mainDiv = document.createElement("div");
        mainDiv.className = "mb-4 p-3 rounded bg-gray-100 shadow-sm";
        mainDiv.innerHTML = `<strong>${escapeHtml(convData.name)}</strong><br>${escapeHtml(convData.message)}<br><span class="text-xs text-gray-500">${escapeHtml(convData.time)}</span>`;
        rightPanel.appendChild(mainDiv);

        // Replies
        const replies = convData.replies || [];
        replies.sort((a,b) => new Date(a.time) - new Date(b.time));
        replies.forEach(reply => {
          const rDiv = document.createElement("div");
          rDiv.className = `mb-2 p-2 rounded shadow-sm max-w-xs ${reply.author===userName ? "bg-green-100 ml-auto text-right" : "bg-white"}`;
          rDiv.innerHTML = `<strong>${escapeHtml(reply.author)}</strong><br>${escapeHtml(reply.text)}<br><span class="text-xs text-gray-500">${escapeHtml(reply.time)}</span>`;
          rightPanel.appendChild(rDiv);
        });

        rightPanel.scrollTop = rightPanel.scrollHeight;
      });
    }

    replyForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentConversationId) return;
      const text = replyInput.value.trim();
      if (!text) return;

      const newReply = {
        author: userName,
        text,
        time: new Date().toISOString(),
        status: "sent"
      };
      try {
        await updateDoc(doc(db, "message", currentConversationId), {
          replies: arrayUnion(newReply)
        });
        replyInput.value = "";
      } catch(err) {
        alert("Failed to send reply: " + err.message);
      }
    });
  </script>
</head>
<body class="flex flex-col md:flex-row min-h-screen">

  <!-- Left panel -->
  <div class="w-full md:w-1/3 border-r border-gray-300 p-4 overflow-y-auto" id="conversationList">
    <h2 class="text-xl font-bold mb-4">Conversations</h2>
    <!-- Conversations dynamically inserted here -->
  </div>

  <!-- Right panel -->
  <div class="w-full md:w-2/3 p-4 flex flex-col">
    <h2 id="selectedTitle" class="text-xl font-bold mb-4">Select a conversation</h2>
    <div id="conversationThread" class="flex-grow overflow-y-auto border rounded p-4 bg-gray-50 mb-4">
      <!-- Conversation thread dynamically inserted here -->
    </div>
    <form id="replyForm" class="flex space-x-2">
      <input id="replyInput" class="flex-grow border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Type a reply..." required>
      <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Send</button>
    </form>
  </div>

</body>
</html>
