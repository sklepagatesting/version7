<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Messenger Chat</title>
<script src="https://cdn.tailwindcss.com"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, doc, setDoc, query, where, onSnapshot, updateDoc, arrayUnion, limit } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDZUVChTTWtGm4R40wMWGrTYwyUk0FDahs",
  authDomain: "sklepaga-8790e.firebaseapp.com",
  projectId: "sklepaga-8790e",
  storageBucket: "sklepaga-8790e.firebasestorage.app",
  messagingSenderId: "815409129057",
  appId: "1:815409129057:web:9f6342be47e28c1f69ec20",
  measurementId: "G-9GH707G2WZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const account = JSON.parse(localStorage.getItem("account") || "{}");
const userId = account.uid;
const userName = account.name;
const userEmail = account.email;
const avatarColor = account.avatarColor || "#10B981"; // user green default
const avatarLetter = account.avatarLetter || userName[0].toUpperCase();

if(!userId || !userName || !userEmail) window.location.href="authentication.html";

const messagesContainer = document.getElementById("messagesContainer");
const replyForm = document.getElementById("replyForm");
const replyInput = document.getElementById("replyInput");

let conversationId = null;

// Admin info
const admin = {
  name: "Dzey Autajay",
  email: "autajaydzey@gmail.com",
  avatarColor: "#3498DB",
  avatarLetter: "D"
};

// Escape HTML
const escapeHtml = text => text ? text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;") : "";

// Add message bubble
function addMessage(author, text, time, isAdmin=false) {
  const wrapper = document.createElement("div");
  wrapper.className = `flex mb-2 ${isAdmin ? "justify-start" : "justify-end"}`;
  const bgColor = isAdmin ? "#DDEBF7" : "#DCFCE7";
  const avatarBg = isAdmin ? admin.avatarColor : avatarColor;
  const letter = isAdmin ? admin.avatarLetter : avatarLetter;
  wrapper.innerHTML = `
    ${isAdmin ? `
    <div class="flex items-start space-x-2">
      <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold" style="background-color:${avatarBg}">${letter}</div>
      <div class="bg-[${bgColor}] rounded-lg p-3 max-w-xs break-words" style="background-color:${bgColor}">
        <p class="text-sm font-semibold">${escapeHtml(author)}</p>
        <p class="text-sm">${escapeHtml(text)}</p>
        <p class="text-xs text-gray-500 text-right">${escapeHtml(time)}</p>
      </div>
    </div>` : `
    <div class="flex items-start space-x-2">
      <div class="bg-[${bgColor}] rounded-lg p-3 max-w-xs break-words" style="background-color:${bgColor}">
        <p class="text-sm font-semibold text-right">${escapeHtml(author)}</p>
        <p class="text-sm">${escapeHtml(text)}</p>
        <p class="text-xs text-gray-500 text-right">${escapeHtml(time)}</p>
      </div>
      <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold" style="background-color:${avatarBg}">${letter}</div>
    </div>`}
  `;
  messagesContainer.appendChild(wrapper);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Initialize conversation
async function initConversation() {
  const messagesCol = collection(db, "message");
  const q = query(messagesCol, where("userEmail","==",userEmail), limit(1));

  onSnapshot(q, async snapshot => {
    messagesContainer.innerHTML = "";
    if(snapshot.empty) {
      // Create initial Admin message
      const now = new Date().toLocaleString("en-PH", { timeZone:"Asia/Manila" }).replace(",", "");
      const newDocRef = doc(messagesCol);
      await setDoc(newDocRef, {
        name: admin.name,
        email: admin.email,
        userId,
        message: "Hello, how can I help you?",
        time: now,
        status: "sent",
        replies: [],
        messageid: newDocRef.id
      });
      conversationId = newDocRef.id;
      addMessage(admin.name, "Hello, how can I help you?", now, true);
    } else {
      conversationId = snapshot.docs[0].id;
      const data = snapshot.docs[0].data();
      addMessage(data.name, data.message, data.time, data.name===admin.name);
      (data.replies || []).sort((a,b)=> new Date(a.time)-new Date(b.time)).forEach(r=>{
        addMessage(r.author, r.text, r.time, r.author===admin.name);
      });
    }
  });
}

// Send reply
replyForm.addEventListener("submit", async e=>{
  e.preventDefault();
  if(!conversationId) return;
  const text = replyInput.value.trim();
  if(!text) return;

  const now = new Date().toLocaleString("en-PH", { timeZone:"Asia/Manila" }).replace(",", "");
  const reply = { author:userName, text, status:"unread", time: now };

  try {
    const docRef = doc(db, "message", conversationId);
    await updateDoc(docRef, { replies: arrayUnion(reply) });
    replyInput.value = "";
  } catch(err) {
    alert("Failed to send: "+err.message);
  }
});

initConversation();
</script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
<div class="flex-1 p-4 flex flex-col max-w-3xl mx-auto">
  <h1 class="text-2xl font-bold mb-4">Messenger Chat</h1>
  <div id="messagesContainer" class="flex-1 overflow-y-auto p-2 space-y-2 bg-white border rounded mb-4"></div>
  <form id="replyForm" class="flex space-x-2">
    <input id="replyInput" type="text" placeholder="Type a message..." class="flex-grow border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded">Send</button>
  </form>
</div>
<div class="absolute top-2 right-2 p-2 bg-white shadow rounded">
  <div><strong>Name:</strong> <span id="userNameDisplay"></span></div>
</div>
<script>
document.getElementById("userNameDisplay").textContent = account.name;
</script>
</body>
</html>
