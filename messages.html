<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Messages</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, arrayUnion, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyDZUVChTTWtGm4R40wMWGrTYwyUk0FDahs",
      authDomain: "sklepaga-8790e.firebaseapp.com",
      projectId: "sklepaga-8790e",
      storageBucket: "sklepaga-8790e.firebasestorage.app",
      messagingSenderId: "815409129057",
      appId: "1:815409129057:web:9f6342be47e28c1f69ec20",
      measurementId: "G-9GH707G2WZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Load current account ---
    const account = JSON.parse(localStorage.getItem("account"));
    if (!account) window.location.href = "authentication.html";

    document.addEventListener("DOMContentLoaded", () => {
      const mainMessageEl = document.getElementById("mainMessage");
      const repliesContainer = document.getElementById("repliesContainer");
      const replyForm = document.getElementById("replyForm");
      const replyInput = document.getElementById("replyInput");

      const conversationDoc = doc(db, "message", "PPKtYIXtsVaXO87HKz2F");

      function escapeHtml(text) {
        if (!text) return "";
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function render(data) {
        // Render main message
        mainMessageEl.innerHTML = `
          <div class="p-3 rounded-lg bg-gray-200 mb-4 shadow">
            <strong>${escapeHtml(data.name)}</strong> <span class="text-xs text-gray-500 ml-2">${escapeHtml(data.time)}</span>
            <p class="mt-1">${escapeHtml(data.message)}</p>
          </div>
        `;

        // Render replies
        repliesContainer.innerHTML = "";
        const replies = data.replies || [];
        replies.sort((a,b) => new Date(a.time) - new Date(b.time));

        replies.forEach(reply => {
          const div = document.createElement("div");
          div.className = `p-2 rounded-lg mb-2 max-w-xs ${reply.author === account.name ? 'bg-blue-500 text-white self-end ml-auto' : 'bg-gray-200 self-start mr-auto'} shadow`;
          div.innerHTML = `<strong>${escapeHtml(reply.author)}</strong> <span class="text-xs text-gray-500 ml-2">${escapeHtml(reply.time)}</span><p>${escapeHtml(reply.text)}</p>`;
          repliesContainer.appendChild(div);
        });

        repliesContainer.scrollTop = repliesContainer.scrollHeight;
      }

      // --- Real-time listener ---
      onSnapshot(conversationDoc, (docSnap) => {
        if (!docSnap.exists()) return;
        const data = docSnap.data();
        render(data);
      });

      // --- Send Reply ---
      replyForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = replyInput.value.trim();
        if (!text) return;

        const now = new Date().toISOString().replace("T"," ").split(".")[0];
        const newReply = {
          author: account.name,
          status: "sent",
          text: text,
          time: now
        };

        await updateDoc(conversationDoc, {
          replies: arrayUnion(newReply)
        });

        replyInput.value = "";
      });

      // Show current user name
      document.getElementById("userNameDisplay").textContent = account.name;
      document.getElementById("userEmailDisplay").textContent = account.email;
    });
  </script>
</head>
<body class="flex flex-col h-screen bg-gray-100 p-4 font-sans">

  <header class="mb-4">
    <h1 class="text-3xl font-bold text-center">Chat</h1>
    <div class="max-w-3xl mx-auto flex justify-between mt-2 bg-gray-50 p-3 rounded shadow">
      <div><strong>Name:</strong> <span id="userNameDisplay"></span></div>
      <div><strong>Email:</strong> <span id="userEmailDisplay"></span></div>
    </div>
  </header>

  <main class="flex-1 max-w-3xl mx-auto flex flex-col overflow-y-auto">
    <div id="mainMessage"></div>
    <div id="repliesContainer" class="flex flex-col"></div>
  </main>

  <footer class="mt-4 max-w-3xl mx-auto">
    <form id="replyForm" class="flex gap-2">
      <input id="replyInput" type="text" placeholder="Type your reply..." class="flex-1 border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded font-semibold">Send</button>
    </form>
  </footer>

</body>
</html>
