<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Messenger</title>
<script src="https://cdn.tailwindcss.com"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, doc, setDoc, onSnapshot,
  query, where, limit, orderBy, addDoc, updateDoc, getDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyDZUVChTTWtGm4R40wMWGrTYwyUk0FDahs",
  authDomain: "sklepaga-8790e.firebaseapp.com",
  projectId: "sklepaga-8790e",
  storageBucket: "sklepaga-8790e.firebasestorage.app",
  messagingSenderId: "815409129057",
  appId: "1:815409129057:web:9f6342be47e28c1f69ec20",
  measurementId: "G-9GH707G2WZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- Current User ---
const account = JSON.parse(localStorage.getItem("account") || "{}");
alert("Loaded account from localStorage: " + JSON.stringify(account));

const userId = account.uid;
const userName = account.name;
const userEmail = account.email;
const userAvatarLetter = account.avatarLetter || (userName ? userName[0].toUpperCase() : "?");
const userAvatarColor = account.avatarColor || "#3498DB";

if (!userId || !userName) {
  alert("User not logged in or invalid account, redirecting...");
  window.location.href = "authentication.html";
}

// --- Admin UID (literally "admin") ---
const adminUid = "admin";
let adminName = "Admin";
let adminAvatarLetter = "A";
let adminAvatarColor = "#3498DB";

// --- DOM Elements ---
const messagesContainer = document.getElementById("messagesContainer");
const replyForm = document.getElementById("replyForm");
const replyInput = document.getElementById("replyInput");
const headerName = document.getElementById("chatHeaderName");

// --- Escape HTML ---
function escapeHtml(text) {
  if (!text) return "";
  return text.replace(/&/g, "&amp;").replace(/</g, "&lt;")
             .replace(/>/g, "&gt;").replace(/"/g, "&quot;")
             .replace(/'/g, "&#39;");
}

// --- Render message ---
function addMessage(senderName, text, timestamp, isAdmin=false, avatarLetter="?", avatarColor="#3498DB") {
  const msgDiv = document.createElement("div");
  msgDiv.className = `flex ${isAdmin ? "justify-start" : "justify-end"} items-end`;

  const avatarHtml = `
    <div class="w-8 h-8 flex items-center justify-center rounded-full text-white font-bold mr-2"
         style="background-color: ${avatarColor}">
      ${escapeHtml(avatarLetter)}
    </div>
  `;

  const messageHtml = `
    <div class="p-3 rounded-2xl mb-2 max-w-[70%] ${isAdmin ? "bg-indigo-50 text-left rounded-tl-none" : "bg-indigo-600 text-white text-right rounded-tr-none"}">
      <div class="font-semibold">${escapeHtml(senderName)}</div>
      <div>${escapeHtml(text)}</div>
      <div class="text-xs text-gray-400 mt-1">${timestamp ? new Date(timestamp.seconds*1000).toLocaleString("en-PH") : ""}</div>
    </div>
  `;

  if(isAdmin){
    msgDiv.innerHTML = avatarHtml + messageHtml;
  } else {
    msgDiv.innerHTML = messageHtml + avatarHtml;
  }

  messagesContainer.appendChild(msgDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// --- Conversation variables ---
let conversationId = null;

// --- Fetch admin profile dynamically ---
async function fetchAdminProfile() {
  try {
    const adminDoc = await getDoc(doc(db, "users", adminUid));
    if(adminDoc.exists()) {
      const data = adminDoc.data();
      adminName = data.name || "Admin";
      adminAvatarLetter = data.avatarLetter || adminName[0].toUpperCase();
      adminAvatarColor = data.avatarColor || "#3498DB";
      alert("Admin profile loaded: " + JSON.stringify(data));
    } else {
      alert("Admin account not found in Firestore, using defaults");
    }
  } catch(err) {
    alert("Error fetching admin profile: " + err.message);
    console.error(err);
  }
}

// --- Initialize / find conversation ---
async function initConversation() {
  alert("Initializing conversation for user: " + userId);
  await fetchAdminProfile();

  const convQuery = query(
    collection(db, "conversations"),
    where("participants", "array-contains", userId),
    limit(1)
  );

  onSnapshot(convQuery, async snapshot => {
    alert("Conversation snapshot received: " + snapshot.size + " document(s)");
    messagesContainer.innerHTML = "";

    if(snapshot.empty){
      alert("No conversation found, creating a new one...");
      const newConvRef = doc(collection(db, "conversations"));
      conversationId = newConvRef.id;
      alert("New conversation ID: " + conversationId);

      await setDoc(newConvRef, {
        participants: [userId, adminUid],
        timeCreated: new Date(),
        lastUpdated: new Date()
      });

      headerName.textContent = adminName;

      // initial admin message
      const msgColRef = collection(db, "conversations", conversationId, "messages");
      const adminMsg = {
        uidSender: adminUid,
        text: "Hello, how can I help you?",
        status: "sent",
        timestamp: new Date()
      };
      await addDoc(msgColRef, adminMsg);
      alert("Initial admin message added");

      addMessage(adminName, adminMsg.text, adminMsg.timestamp, true, adminAvatarLetter, adminAvatarColor);

    } else {
      const docSnap = snapshot.docs[0];
      conversationId = docSnap.id;
      alert("Existing conversation found, ID: " + conversationId);
      headerName.textContent = adminName;

      const msgColRef = collection(db, "conversations", conversationId, "messages");
      const msgQuery = query(msgColRef, orderBy("timestamp", "asc"));
      onSnapshot(msgQuery, msgSnapshot => {
        alert("Messages snapshot received: " + msgSnapshot.size + " message(s)");
        messagesContainer.innerHTML = "";
        for(const msgDoc of msgSnapshot.docs){
          const msgData = msgDoc.data();
          const isAdmin = msgData.uidSender === adminUid;
          const senderName = isAdmin ? adminName : userName;
          const avatarLetter = isAdmin ? adminAvatarLetter : userAvatarLetter;
          const avatarColor = isAdmin ? adminAvatarColor : userAvatarColor;

          addMessage(senderName, msgData.text, msgData.timestamp, isAdmin, avatarLetter, avatarColor);
        }
      });
    }
  });
}

initConversation();

// --- Send reply ---
replyForm.addEventListener("submit", async e => {
  e.preventDefault();
  if(!conversationId) {
    alert("Cannot send message: conversationId is null");
    return;
  }
  const text = replyInput.value.trim();
  if(!text) {
    alert("Cannot send empty message");
    return;
  }

  const msgColRef = collection(db, "conversations", conversationId, "messages");
  const newMsg = {
    uidSender: userId,
    text,
    status: "unread",
    timestamp: new Date()
  };

  try {
    await addDoc(msgColRef, newMsg);
    const convRef = doc(db, "conversations", conversationId);
    await updateDoc(convRef, { lastUpdated: new Date() });
    replyInput.value = "";
    alert("Message sent successfully");
  } catch(err){
    alert("Failed to send reply: " + err.message);
    console.error(err);
  }
});
</script>

<style>
#messagesContainer::-webkit-scrollbar {
  width: 8px;
}
#messagesContainer::-webkit-scrollbar-thumb {
  background-color: rgba(0,0,0,0.2);
  border-radius: 4px;
}
</style>
</head>

<body class="bg-gray-50 flex flex-col h-screen p-4 overflow-hidden">

<!-- Header showing other side -->
<div class="bg-white p-4 shadow rounded mb-4 flex items-center">
  <div id="chatHeaderName" class="font-bold text-lg"></div>
</div>

<!-- Chat container -->
<div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-2 bg-white border rounded mb-4 max-h-[75vh]"></div>

<!-- Reply form -->
<form id="replyForm" class="flex space-x-2">
  <input id="replyInput" type="text" placeholder="Type your message..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
         class="flex-grow border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
  <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded">Send</button>
</form>

</body>
</html>