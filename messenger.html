<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>User Messages</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      addDoc,
      updateDoc,
      collection,
      query,
      orderBy,
      onSnapshot,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ------------------ FIREBASE INIT ------------------
    const firebaseConfig = {
  apiKey: "AIzaSyDZUVChTTWtGm4R40wMWGrTYwyUk0FDahs",
  authDomain: "sklepaga-8790e.firebaseapp.com",
  projectId: "sklepaga-8790e",
  storageBucket: "sklepaga-8790e.appspot.com",
  messagingSenderId: "815409129057",
  appId: "1:815409129057:web:9f6342be47e28c1f69ec20",
  measurementId: "G-9GH707G2WZ"
};

    // ------------------ AUTH GUARD ------------------
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html"; // force login
        return;
      }

      // check if user is admin
      const adminDoc = await getDoc(doc(db, "admins", user.uid));
      if (adminDoc.exists()) {
        // block admin from user chat
        await signOut(auth);
        window.location.href = "index.html";
        return;
      }

      currentUser = user;

      // Get/create conversation with system (admin support chat)
      conversationId = await getOrCreateConversation(currentUser.uid);

      // Start listening to messages
      listenForMessages(conversationId);
    });

    // ------------------ CONVERSATION HANDLER ------------------
    async function getOrCreateConversation(userId) {
      const convRef = doc(db, "conversations", userId); // 1-to-1 user<->admin conv, using userId as id
      const convSnap = await getDoc(convRef);

      if (!convSnap.exists()) {
        await setDoc(convRef, {
          participants: [userId, "admin"], // track participants
          lastMessage: "",
          lastUpdated: serverTimestamp()
        });
      }
      return convRef.id;
    }

    // ------------------ MESSAGE SENDING ------------------
    async function sendMessage() {
      const input = document.getElementById("message-input");
      const text = input.value.trim();
      if (!text || !currentUser) return;

      const messagesRef = collection(db, "conversations", conversationId, "messages");

      // create new message
      const newMsg = {
        senderId: currentUser.uid,
        text,
        status: "sent",
        timestamp: serverTimestamp()
      };

      const msgRef = await addDoc(messagesRef, newMsg);

      // update conversation last message
      await updateDoc(doc(db, "conversations", conversationId), {
        lastMessage: text,
        lastUpdated: serverTimestamp()
      });

      input.value = "";
    }

    // ------------------ LISTENER ------------------
    function listenForMessages(conversationId) {
      const messagesRef = collection(db, "conversations", conversationId, "messages");
      const q = query(messagesRef, orderBy("timestamp", "asc"));

      onSnapshot(q, (snapshot) => {
        const chatBox = document.getElementById("chat-box");
        chatBox.innerHTML = ""; // clear and re-render (or could append)
        snapshot.forEach((doc) => {
          const msg = doc.data();
          const div = document.createElement("div");

          const isMe = msg.senderId === currentUser.uid;
          div.className = `p-2 my-1 rounded-lg max-w-[70%] ${
            isMe ? "ml-auto bg-blue-500 text-white" : "mr-auto bg-gray-200 text-gray-800"
          }`;

          div.textContent = msg.text;
          chatBox.appendChild(div);
        });

        // scroll to bottom
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }
  </script>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-xl font-semibold">Messages</h1>
    <button onclick="signOut(auth)" class="text-red-500 font-medium">Logout</button>
  </header>

  <!-- Chat Messages -->
  <main id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50"></main>

  <!-- Chat Input Wrapper (untouched but functional) -->
  <div class="bg-white p-3 border-t flex items-center space-x-2">
    <input
      id="message-input"
      type="text"
      placeholder="Type a message..."
      class="flex-1 border rounded-full px-4 py-2 focus:outline-none focus:ring focus:ring-blue-300"
    />
    <button
      onclick="sendMessage()"
      class="bg-blue-500 text-white rounded-full px-4 py-2 hover:bg-blue-600 transition"
    >
      Send
    </button>
  </div>
</body>
</html>